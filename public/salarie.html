<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
  <title>PCELEC</title>
  <style>
    :root{
      --primary:#1976d2;--muted:#6b7280;--bg:#fafafa;--card:#fff;--radius:8px;
      --planning-col-width:240px;
      --table-stripe:#f8fafc;--table-hover:#eef2ff;
    }
    html{min-height:100%;overflow-x:hidden;overflow-y:auto;}
    html,body{height:100%;margin:0;font-family:Inter,Arial,sans-serif;background:var(--bg);color:#111;}
    body{min-height:100%;margin:0;overflow-y:auto;-webkit-overflow-scrolling:touch;overscroll-behavior-y:contain;touch-action:pan-y;font-size:48px;}
    .container{width:100%;max-width:none;margin:0;padding:40px;margin-bottom:200px;box-sizing:border-box;}
    h2{margin:0 0 32px 0;color:#1976d2;font-size:60px;}
    label{display:block;margin-top:24px;font-size:48px;color:#333;}
    select,input[type="time"],input[type="text"],input[type="password"],textarea,input[type="date"]{display:block;width:100%!important;padding:20px;border:2px solid #e5e7eb;border-radius:12px;font-size:48px;background:#fff;box-sizing:border-box;-webkit-text-size-adjust:100%;}
    textarea{min-height:200px;}
    .card{background:var(--card);border-radius:var(--radius);padding:36px;box-shadow:0 12px 32px rgba(16,24,40,0.06);margin-bottom:36px;}
    .muted{color:var(--muted);font-size:42px;}
    .actions{display:flex;gap:20px;margin-top:32px;flex-wrap:wrap;}
    button{background:var(--primary);color:#fff;border:none;padding:20px 30px;border-radius:16px;font-weight:600;cursor:pointer;font-size:48px;min-height:80px;}
    button.secondary{background:#666;}
    .small{padding:16px 24px;font-size:42px;min-height:72px;}
    .hidden{display:none}
    .error-text{color:#b91c1c;font-size:42px;margin-top:16px;display:none;}
    .fixed-footer{position:fixed;left:0;right:0;bottom:0;display:flex;justify-content:space-between;align-items:center;gap:16px;z-index:40;padding:20px;padding-bottom:calc(20px + env(safe-area-inset-bottom));}
    .fixed-footer.hidden{display:none}
    .footer-left{display:flex;gap:16px;align-items:center;}
    .footer-right{color:var(--muted);font-size:36px;}
    #historyPanel{
      position:fixed;
      left:0;
      right:0;
      bottom:100px;
      max-height:calc(100vh - 80px);
      background:var(--card);
      border-radius:20px;
      padding:32px;
      box-shadow:0 36px 120px rgba(2,6,23,0.2);
      overflow:auto;
      overscroll-behavior:none;
      display:none;
      z-index:50;
      padding-bottom:calc(48px + env(safe-area-inset-bottom));
      font-size:10px;
      touch-action:pan-y;
    }
    #planningPanel{
      position:fixed;left:0;right:0;bottom:120px;
      max-height:calc(100vh - 100px);
      background:var(--card);
      border-radius:20px;
      padding:32px;
      box-shadow:0 36px 120px rgba(2,6,23,0.2);
      overflow:auto;
      overscroll-behavior:none;
      display:none;z-index:50;
      padding-bottom:calc(32px + env(safe-area-inset-bottom));
      font-size:10px;
      touch-action:pan-y;
    }
    .h-scrollbar{position:sticky;top:0;z-index:5;height:16px;background:#f1f5f9;overflow-x:auto;overflow-y:hidden;scrollbar-gutter:stable both-edges;}
    .h-scrollbar-inner{height:1px;}
    .table-wrap{overflow:auto;max-height:calc(100vh - 240px);-webkit-overflow-scrolling:touch;overscroll-behavior:none;width:100%;transform:translateZ(0);margin-bottom:300px;}
    table{min-width: 100%;border-collapse:collapse;font-size:26px;width:auto;padding-bottom:100px;}
    th,td{border:14px solid #eee;padding:18px;text-align:left}
    tbody tr:nth-child(odd){background:#ffffff;}
    tbody tr:nth-child(even){background:#e0f2ff;}
    th{background:#fbfbfb;position:sticky;top:0}
    .entry-block{border:2px dashed #ddd;padding:20px;border-radius:12px;margin-top:20px;}
    .entry-actions{display:flex;gap:16px;margin-top:20px;flex-wrap:wrap;}
    .chantier-block{border:2px dashed #ddd;padding:20px;border-radius:12px;margin-top:20px;}
    .deplacement-block{border:2px dashed #ddd;padding:20px;border-radius:12px;margin-top:20px;}
    .interim-block{border:2px dashed #cbd5e1;padding:20px;border-radius:12px;margin-top:20px;background:#fff;}
    .interim-actions{display:flex;gap:16px;margin-top:20px;align-items:center;}
    @media (max-width:768px){.container{padding:32px;margin-bottom:180px;}button,.small{padding:18px 26px;font-size:48px;min-height:76px;}.muted{font-size:42px;}.error-text{font-size:42px;}.status-text{font-size:48px;}h2{font-size:56px;}label{font-size:48px;}}
    .msg{margin-top:24px;color:green;font-size:42px}
    .inline{display:inline-block;margin-right:16px;}
    .status-text{font-weight:700;font-size:42px;margin-left:16px;}
    .status-green{color:#059669;}
    .status-red{color:#b91c1c;}
    .planning-container{position: relative;max-height:70vh;width:100%;overflow:auto;border:1px solid #e5e7eb;background:#fff;box-sizing:border-box;}
    .planning-table{border-collapse:collapse;width:max-content;min-width:200px;font-size:26px;}
    .planning-table th,.planning-table td{
      box-sizing:border-box;padding:14px 10px;text-align:left;border:1px solid #eee;
      min-width:var(--planning-col-width);width:var(--planning-col-width);max-width:var(--planning-col-width);
      overflow:hidden;white-space:nowrap;text-overflow:ellipsis;background:#fff;
    }
    .planning-table thead th{position:sticky;top:0;z-index:15;background:#f1f5f9;font-weight:800;box-shadow:0 2px 6px rgba(0,0,0,0.04);}
    .planning-table th.col-emp,.planning-table td.col-emp{position:sticky;left:0;z-index:18;background:#fff;box-shadow:6px 0 8px rgba(0,0,0,0.04);}
    .planning-table thead th.col-emp{z-index:19;}
    .planning-table tbody tr:nth-child(odd) td{background:var(--table-stripe,#fff);}
    .planning-table tbody tr:nth-child(even) td{background:var(--table-hover,#eef2ff);}
    .pill{background:linear-gradient(120deg,#2563eb,#38bdf8);color:#fff;border-radius:12px;padding:10px 12px;font-size:22px;font-weight:700;display:block;margin:4px 0;white-space:normal;word-break:break-word;}
    .pill small{display:block;color:#e0f2fe;font-weight:600;font-size:20px;}
    .today-col{background:#fff7d6 !important;}
    select option.opt-assigned-camp { background:#fff3c4; color:#92400e; font-weight:700; }
    select option.opt-assigned-aff { background:#dbeafe; color:#1d4ed8; font-weight:700; }
  </style>
</head>

<body>
  <div class="container">
    <div style="text-align:center;margin-bottom:32px;">
      <img id="appLogo" alt="appLogo" style="height:240px;max-width:100%;display:none;">
    </div>

    <div id="page-form" class="card" style="padding-bottom:48px">
      <h2>Pointage</h2>
      <div class="muted">
        Utilisateur connecté : <b id="userLabel"></b>
        <br><span id="matriculeDisplay" class="muted"></span>
        <span id="tachesStatus" class="status-text status-green" style="margin-left:12px;"></span>
      </div>
      <div id="err_global" class="error-text"></div>

      <label>Type
        <select id="typePersonne" onchange="majTypePersonne()">
          <option value="">-- Choisir --</option>
          <option value="salarie">Salarié</option>
          <option value="interimaire">Intérimaire</option>
        </select>
      </label>
      <div id="err_typePersonne" class="error-text"></div>

      <div id="form-sections" class="hidden">
        <div id="bloc-interimaire" class="hidden">
          <div id="interimContainer" style="margin-top:24px"></div>
          <div class="interim-actions" style="margin-top:24px;">
            <button class="small" onclick="ajouterInterimaire()">Ajouter intérimaire</button>
          </div>
        </div>

        <div id="entries-section" class="hidden">
          <div id="entriesContainer"></div>
          <div class="entry-actions">
            <div id="loadingIndicator" style="display:none;color:var(--muted);font-size:32px;margin-right:16px;">Ajout en cours...</div>
            <button class="small" onclick="ajouterChantier()">Ajouter un chantier</button>
            <button class="small" onclick="ajouterDeplacement()">Ajouter déplacement</button>
          </div>
          <div id="err_entries" class="error-text"></div>
        </div>

        <div class="actions" style="margin-top:32px;">
          <button id="btnValider" onclick="valider()" class="small">Valider</button>
          <span id="transferStatus" class="status-text"></span>
          <div class="msg" id="msg"></div>
        </div>
      </div>
    </div>

    <div id="mes-taches-card" class="card">
      <h2 style="margin-bottom:20px;">Mes tâches planifiées</h2>
      <div class="muted" style="margin-bottom:12px;">Tâches du jour</div>
      <div id="tachesToday" class="muted" style="margin-bottom:24px;">Chargement...</div>

      <div class="muted" style="margin-bottom:12px;">Filtre par dates</div>
      <label>Du
        <input type="date" id="uDateFrom">
      </label>
      <label>Au
        <input type="date" id="uDateTo">
      </label>
      <div class="actions" style="margin-top:24px;">
        <button class="small" onclick="chargerMesTaches()">Actualiser</button>
      </div>
      <div id="tachesContent" class="muted" style="margin-top:18px;">Choisissez une plage de dates puis cliquez sur Actualiser.</div>
    </div>
  </div>

  <div id="historyPanel" aria-hidden="true">
    <div id="historyHeader" style="margin-top: 100px;">
      <strong id="historyTitle" style="font-size:48px;">Historique</strong>
      <div>
        <button id="btnExportPDF" onclick="telechargerPDF()" style="padding:8px 12px; font-size:32px; min-height:40px;">Exporter PDF</button>
        <button class="secondary" onclick="fermerHistorique()" style="padding:8px 12px; font-size:32px; min-height:40px;">Fermer</button>
      </div>
    </div>

    <div id="historyFilters" style="display:flex;flex-wrap:wrap;gap:16px;align-items:flex-end;margin-bottom:24px;">
      <label style="font-size:32px;">De
        <input type="date" id="histDateFrom" style="font-size:32px;padding:12px;">
      </label>
      <label style="font-size:32px;">À
        <input type="date" id="histDateTo" style="font-size:32px;padding:12px;">
      </label>
      <label style="font-size:32px;">Salarié
        <select id="histSalarie" style="font-size:32px;padding:12px;min-width:260px;">
          <option value="">Tous</option>
        </select>
      </label>
      <label style="font-size:32px;">Camping
        <select id="histCamping" style="font-size:32px;padding:12px;min-width:260px;">
          <option value="">Tous</option>
        </select>
      </label>
      <button onclick="applyHistoryFilters()" class="small" style="font-size:32px;min-height:72px;">Appliquer</button>
      <button onclick="callHistorique(true)" class="secondary small" style="font-size:32px;min-height:72px;">Actualiser</button>
    </div>

    <div id="historyContent" style="padding-top: 20px;"><div class="muted">Clique sur Appliquer pour charger l'historique.</div></div>
  </div>

  <div id="planningPanel" aria-hidden="true">
    <div id="planningHeader" style="margin-top: 100px.;">
      <strong id="planningTitle" style="font-size:48px;">Planning de l'équipe</strong>
      <div>
        <button class="small" onclick="actualiserPlanning()" style="padding:8px 12px; font-size:32px; min-height:40px;">Actualiser</button>
        <button class="secondary" onclick="fermerPlanning()" style="padding:8px 12px; font-size:32px; min-height:40px;">Fermer</button>
      </div>
    </div>

    <div id="planningFilters" style="display:flex;flex-wrap:wrap;gap:16px;align-items:flex-end;margin-bottom:24px;">
      <label style="font-size:32px;">Du
        <input type="date" id="planDateFrom" style="font-size:32px;padding:12px;">
      </label>
      <label style="font-size:32px;">Au
        <input type="date" id="planDateTo" style="font-size:32px;padding:12px;">
      </label>
      <label style="font-size:32px;">Salarié
        <select id="planSalarie" style="font-size:32px;padding:12px;min-width:260px;">
          <option value="">Tous</option>
        </select>
      </label>
      <button onclick="actualiserPlanning()" class="small" style="font-size:32px;min-height:72px;">Appliquer</button>
      <button onclick="actualiserPlanning()" class="secondary small" style="font-size:32px;min-height:72px;">Actualiser</button>
    </div>

    <div id="planningContent" style="padding-top:20px;"><div class="muted">Choisissez une plage de dates puis cliquez sur Appliquer.</div></div>
  </div>

  <div id="validesPanel" aria-hidden="true" style="position:fixed;left:0;right:0;bottom:160px;max-height:calc(100vh - 160px);background:#fff;border-radius:20px;padding:32px;box-shadow:0 36px 120px rgba(2,6,23,0.2);overflow:auto;overscroll-behavior:none;display:none;z-index:50;padding-bottom:calc(32px + env(safe-area-inset-bottom));font-size:32px;touch-action:pan-y;">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:24px;">
      <strong style="font-size:48px;">Mes pointages validés</strong>
      <div>
        <button class="small" onclick="actualiserValides()" style="padding:8px 12px; font-size:32px; min-height:40px;">Actualiser</button>
        <button class="small" onclick="exportValidesPDF()" style="padding:8px 12px; font-size:32px; min-height:40px;">Exporter PDF</button>
        <button class="secondary" onclick="fermerValides()" style="padding:8px 12px; font-size:32px; min-height:40px;">Fermer</button>
      </div>
    </div>

    <div style="display:flex;flex-wrap:wrap;gap:16px;align-items:flex-end;margin-bottom:24px;">
      <label style="font-size:32px;">De
        <input type="date" id="valDateFrom" style="font-size:32px;padding:12px;">
      </label>
      <label style="font-size:32px;">À
        <input type="date" id="valDateTo" style="font-size:32px;padding:12px;">
      </label>
      <button onclick="actualiserValides()" class="small" style="font-size:32px;min-height:72px;">Appliquer</button>
      <button onclick="resetValidesFilters()" class="secondary small" style="font-size:32px;min-height:72px;">Actualiser</button>
    </div>

    <div id="valStatus" class="muted" style="margin-bottom:12px;">Choisissez des dates puis cliquez sur Appliquer.</div>
    <div id="valContent" class="table-wrap" style="overflow:auto;max-height:65vh;">
      <div class="muted">Aucune donnée.</div>
    </div>
  </div>

  <div id="fixedFooter" class="fixed-footer hidden" aria-hidden="true">
    <div class="footer-left">
      <button id="btnShowHistory" onclick="afficherHistorique()" style="font-size:36px;padding:12px 20px;min-height:60px;">Afficher l'historique</button>
      <button id="btnShowPlanning" onclick="afficherPlanning()" style="font-size:36px;padding:12px 20px;min-height:60px;">Afficher le planning</button>
      <button id="btnShowValides" onclick="afficherValides()" style="font-size:36px;padding:12px 20px;min-height:60px;">Pointages validés</button>
      <button id="btnFooterLogout" class="secondary" onclick="logout()" style="font-size:36px;padding:12px 20px;min-height:60px;">Déconnexion</button>
    </div>
    <div class="footer-right" id="appCredit">PCELEC</div>
  </div>

  <template id="interimTpl">
    <div class="interim-block">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <strong class="interim-title">Intérimaire</strong>
        <button class="small" onclick="supprimerInterimaire(this)">Supprimer</button>
      </div>
      <label>Nom <input type="text" class="it_nom"></label>
      <div class="error-text it_err_nom" style="display:none;"></div>

      <label>Camping <select class="it_camping" onchange="majAffairesInterimaireBlock(this)"></select></label>
      <div class="error-text it_err_camping" style="display:none;"></div>

      <label>Affaire <select class="it_affaire"></select></label>
      <div class="error-text it_err_affaire" style="display:none;"></div>

      <label>Tâche réalisée <textarea class="it_tache"></textarea></label>
      <div class="error-text it_err_tache" style="display:none;"></div>

      <label>Heure début <input type="time" class="it_debut"></label>
      <div class="error-text it_err_debut" style="display:none;"></div>
      <label>Heure fin <input type="time" class="it_fin"></label>
      <div class="error-text it_err_fin" style="display:none;"></div>
    </div>
  </template>

  <template id="chantierTpl">
    <div class="chantier-block">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;">
        <strong class="chantier-title">Chantier</strong>
        <button class="small" onclick="supprimerEntry(this)">Supprimer</button>
      </div>
      <label>Camping
        <select class="mc_camping" onchange="majAffairesChantier(this)"></select>
      </label>
      <div class="error-text mc_err_camping" style="display:none;"></div>

      <label>Affaire
        <select class="mc_affaire"></select>
      </label>
      <div class="error-text mc_err_affaire" style="display:none;"></div>

      <label>Tâche réalisée
        <textarea class="mc_tache"></textarea>
      </label>
      <div class="error-text mc_err_tache" style="display:none;"></div>

      <label>Heure début
        <input type="time" class="mc_heureDebut">
      </label>
      <div class="error-text mc_err_debut" style="display:none;"></div>

      <label>Heure fin
        <input type="time" class="mc_heureFin">
      </label>
      <div class="error-text mc_err_fin" style="display:none;"></div>

      <div style="margin-top:16px;">
        <button class="small" onclick="ajouterPause(this)">Ajouter pause</button>
      </div>
    </div>
  </template>

  <template id="deplacementTpl">
    <div class="deplacement-block">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;">
        <strong class="deplacement-title">Déplacement</strong>
        <button class="small" onclick="supprimerEntry(this)">Supprimer</button>
      </div>
      <label>Type:
        <select class="dtype">
          <option value="domicile">Domicile</option>
          <option value="travail">Travail</option>
        </select>
      </label>
      <label>Commentaire: <input class="d-comment" type="text" required></label>
      <div class="error-text d_err_comment" style="display:none;"></div>
      <label>Début: <input class="d-debut" type="time"></label>
      <div class="error-text d_err_debut" style="display:none;"></div>
      <label>Fin: <input class="d-fin" type="time"></label>
      <div class="error-text d_err_fin" style="display:none;"></div>
    </div>
  </template>

  <script>
    const BASE_URL = "<?= ScriptApp.getService().getUrl() ?>";
    function getBaseUrl(){ return BASE_URL; }

    const IS_LOCAL = location.hostname === 'localhost' || location.hostname === '127.0.0.1';
      const USE_LOCAL = (typeof google === 'undefined' || !google.script || !google.script.run);
  const API_BASE = USE_LOCAL
    ? ((location.hostname === "localhost" || location.hostname === "127.0.0.1")
        ? "http://localhost:3000/api"
        : "https://pointage-oeax.onrender.com/api")
    : '';
    async function apiGet(path){ const r=await fetch(API_BASE+path); if(!r.ok) throw new Error(r.statusText); return r.json(); }
    async function apiPost(path, body){
      const r=await fetch(API_BASE+path,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(body||{})});
      if(!r.ok) throw new Error(r.statusText); return r.json();
    }

    let campingsAffaires = [];
    let currentUser = '';
    let currentMatricule = '';
    let cachedHistory = null;
    let historyHeaderIndices = { date:-1, nom:-1, camping:-1 };
    let cachedPlanning = null;
    let planningEmployees = [];
    let cachedValides = [];

    let assignedCampings = new Set();
    let assignedAffaires = new Map();
    const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent || '');

    function minToHHMM(m){ m=parseInt(m||0,10); const h=Math.floor(m/60); const mm=String(m%60).padStart(2,'0'); return `${h}:${mm}`; }
    function fmtDateDisplay(isoStr){
      if(!isoStr) return '';
      const parts = isoStr.split('-');
      if(parts.length===3){
        const [y,m,d]=parts;
        return `${d}/${m}/${y}`;
      }
      return isoStr;
    }
    function fmtDateLocal(d){ const y=d.getFullYear(); const m=String(d.getMonth()+1).padStart(2,'0'); const da=String(d.getDate()).padStart(2,'0'); return `${y}-${m}-${da}`; }
    function fmtHHMM(v){
      if(v==null) return '';
      const s=String(v).trim();
      const m=s.match(/^(\d{1,2}):(\d{2})(?::\d{2})?$/);
      if(m) return `${m[1].padStart(2,'0')}:${m[2]}`;
      return s;
    }
    function fmtDateTimeDisplay(val){
      if(!val) return '';
      const d = new Date(val);
      if (isNaN(d)) return val;
      const dd = String(d.getDate()).padStart(2,'0');
      const mm = String(d.getMonth()+1).padStart(2,'0');
      const yyyy = d.getFullYear();
      const hh = String(d.getHours()).padStart(2,'0');
      const mi = String(d.getMinutes()).padStart(2,'0');
      return `${dd}/${mm}/${yyyy} ${hh}:${mi}`;
    }

    window.onload = function(){
      const params = new URLSearchParams(window.location.search);
      currentUser = params.get('u') || '';
      if (!currentUser) {
        try { currentUser = localStorage.getItem('userLogin') || ''; } catch(e){}
      }
      if (!currentUser) {
        document.getElementById('userLabel').textContent = '';
        showError('global', 'Utilisateur non identifié (paramètre manquant).');
        return;
      }
      document.getElementById('userLabel').textContent = currentUser;

      document.getElementById('fixedFooter').classList.remove('hidden');
      chargerCampingsEtAffaires();
      chargerEmployesPlanning();
      loadLogoFromCode();
      chargerMatricule();
      setDefaultTaskDates();
      setDefaultPlanningDates();
      setDefaultValidesDates();
      chargerTachesAujourdHui();
    };

    function logout(){
      try { localStorage.removeItem('userLogin'); } catch(e){}
      window.location.href = 'index.html';
    }

    function loadLogoFromCode() {
      if (USE_LOCAL) return;
      if (typeof google === 'undefined' || !google.script || !google.script.run) return;
      google.script.run.withSuccessHandler(function(url){
        if (!url) return;
        const img = document.getElementById('appLogo');
        if (!img) return;
        img.src = url;
        img.style.display = 'inline-block';
      }).withFailureHandler(function(err){
        console.error('Erreur chargement logo depuis Code.gs :', err);
      }).getLogoUrlDirect();
    }

    function setDefaultTaskDates(){
      const today = new Date();
      const in7 = new Date(); in7.setDate(today.getDate()+7);
      const iso = d => d.toISOString().slice(0,10);
      const df = document.getElementById('uDateFrom');
      const dt = document.getElementById('uDateTo');
      if (df) df.value = iso(today);
      if (dt) dt.value = iso(in7);
    }

    function setDefaultPlanningDates(){
      const today = new Date();
      const in7 = new Date(); in7.setDate(today.getDate()+7);
      const iso = d => d.toISOString().slice(0,10);
      const df = document.getElementById('planDateFrom');
      const dt = document.getElementById('planDateTo');
      if (df) df.value = iso(today);
      if (dt) dt.value = iso(in7);
    }

    function setDefaultValidesDates(){
      const today = new Date();
      const start = new Date(); start.setDate(today.getDate()-7);
      const iso = d => d.toISOString().slice(0,10);
      const df = document.getElementById('valDateFrom');
      const dt = document.getElementById('valDateTo');
      if (df) df.value = iso(start);
      if (dt) dt.value = iso(today);
    }

    function setDefaultHistoryToday(){
      const today = new Date().toISOString().slice(0,10);
      const df = document.getElementById('histDateFrom');
      const dt = document.getElementById('histDateTo');
      if (df) df.value = today;
      if (dt) dt.value = today;
    }

    async function chargerCampingsEtAffaires(){
      try{
        if (USE_LOCAL){
          campingsAffaires = await apiGet('/getCampingsEtAffaires');
          return;
        }
        google.script.run.withSuccessHandler(function(list){
          campingsAffaires = list || [];
        }).withFailureHandler(function(err){ console.error(err); }).getCampingsEtAffaires();
      }catch(err){ console.error(err); }
    }

    async function chargerEmployesPlanning(){
      try{
        if (USE_LOCAL){
          const list = await apiGet('/getEmployes');
          planningEmployees = (list||[])
            .filter(e => (e.role || '').toLowerCase() === 'user')
            .map(e => e.nom)
            .filter(Boolean)
            .sort((a,b)=>a.localeCompare(b,'fr',{sensitivity:'base'}));
          const sel = document.getElementById('planSalarie');
          if (sel){
            sel.innerHTML = '<option value="">Tous</option>';
            planningEmployees.forEach(n=>{
              const o=document.createElement('option'); o.value=n; o.textContent=n; sel.appendChild(o);
            });
          }
          const hsel = document.getElementById('histSalarie');
          if (hsel){
            hsel.innerHTML = '<option value="">Tous</option>';
            planningEmployees.forEach(n=>{
              const o=document.createElement('option'); o.value=n; o.textContent=n; hsel.appendChild(o);
            });
          }
          return;
        }
        google.script.run.withSuccessHandler(function(list){
          planningEmployees = (list||[])
            .filter(e => (e.role || '').toLowerCase() === 'user')
            .map(e => e.nom)
            .filter(Boolean)
            .sort((a,b)=>a.localeCompare(b,'fr',{sensitivity:'base'}));
          const sel = document.getElementById('planSalarie');
          if (sel){
            sel.innerHTML = '<option value="">Tous</option>';
            planningEmployees.forEach(n=>{
              const o=document.createElement('option'); o.value=n; o.textContent=n; sel.appendChild(o);
            });
          }
          const hsel = document.getElementById('histSalarie');
          if (hsel){
            hsel.innerHTML = '<option value="">Tous</option>';
            planningEmployees.forEach(n=>{
              const o=document.createElement('option'); o.value=n; o.textContent=n; hsel.appendChild(o);
            });
          }
        }).withFailureHandler(function(err){ console.error(err); }).getEmployes();
      }catch(err){ console.error(err); }
    }

    function chargerMatricule(){
      if (USE_LOCAL){ currentMatricule = ''; return; }
      google.script.run.withSuccessHandler(function(m){
        currentMatricule = m || '';
        const lbl = document.getElementById('matriculeDisplay');
        if (lbl) lbl.textContent = currentMatricule ? ('Matricule: ' + currentMatricule) : '';
      }).getMatriculeForName(currentUser);
    }

    function addDays(d,n){ const c=new Date(d); c.setDate(c.getDate()+n); c.setHours(0,0,0,0); return c; }

    async function chargerTachesAujourdHui(){
      const todayIso = new Date().toISOString().slice(0,10);
      const key = (currentMatricule || currentUser || '').trim().toLowerCase();
      const box = document.getElementById('tachesToday');
      if (box) box.textContent = "Chargement...";
      const badge = document.getElementById('tachesStatus');
      if (badge) { badge.textContent = ""; badge.classList.remove('status-red'); badge.classList.add('status-green'); }

      try{
        let list = [];
        if (USE_LOCAL){
          list = await apiPost('/getPlanning', { startIso: todayIso, endIso: todayIso });
        } else {
          list = await new Promise((resolve,reject)=>{
            google.script.run.withSuccessHandler(resolve).withFailureHandler(reject).getPlanningForUser(key, todayIso, todayIso);
          });
        }
        const todayList = (list||[]).filter(t=>{
          const k1 = (t.salarie||'').toLowerCase();
          const k2 = (t.matricule||'').toLowerCase();
          return key && (k1===key || k2===key) && t.date===todayIso;
        });
        renderTachesToday(todayList);
        setAssignedFromList(todayList);
        if (badge) {
          badge.textContent = 'Tâches affectées : ' + (todayList ? todayList.length : 0);
          badge.classList.remove('status-red');
          badge.classList.add('status-green');
        }
      }catch(err){
        console.error(err);
        if (box) box.textContent = "Erreur de chargement.";
        if (badge) { badge.textContent = 'Erreur de chargement'; badge.classList.add('status-red'); }
      }
    }

    async function chargerMesTaches(){
      const box = document.getElementById('tachesContent');
      if (box) box.textContent = "Chargement...";

      const df = document.getElementById('uDateFrom').value || '';
      const dt = document.getElementById('uDateTo').value || '';
      const key = (currentMatricule || currentUser || '').trim().toLowerCase();

      try{
        let list = [];
        if (USE_LOCAL){
          list = await apiPost('/getPlanning', { startIso: df || '1900-01-01', endIso: dt || '2100-12-31' });
        } else {
          list = await new Promise((resolve,reject)=>{
            google.script.run.withSuccessHandler(resolve).withFailureHandler(reject).getPlanningForUser(key, df, dt);
          });
        }
        const mine = (list||[]).filter(t=>{
          const k1 = (t.salarie||'').toLowerCase();
          const k2 = (t.matricule||'').toLowerCase();
          return key && (k1===key || k2===key);
        });
        renderMesTaches(mine);
        setAssignedFromList(mine);
      }catch(err){
        console.error(err);
        if (box) box.textContent = "Erreur de chargement.";
      }
    }

    function setAssignedFromList(list){
      assignedCampings = new Set();
      assignedAffaires = new Map();
      (list||[]).forEach(t=>{
        const camp = (t.camping||'').trim();
        const aff  = (t.affaire||'').trim();
        if (camp) {
          assignedCampings.add(camp);
          if (!assignedAffaires.has(camp)) assignedAffaires.set(camp, new Set());
          if (aff) assignedAffaires.get(camp).add(aff);
        }
      });
      refreshOptionHighlights();
    }

    function ensureBaseLabel(opt){
      if(!opt.dataset.baseLabel) opt.dataset.baseLabel = opt.textContent;
      return opt.dataset.baseLabel;
    }
    function decorateOption(opt, className, isHighlight, mobilePrefix){
      const base = ensureBaseLabel(opt);
      opt.classList.remove('opt-assigned-camp','opt-assigned-aff');
      opt.textContent = base;
      if (isHighlight){
        opt.classList.add(className);
        if (isIOS && mobilePrefix) opt.textContent = mobilePrefix + base;
      }
    }

    function refreshOptionHighlights(){
      document.querySelectorAll('.mc_camping, .it_camping').forEach(applyCampingOptionStyles);
      document.querySelectorAll('.mc_affaire').forEach(sel=>{
        const camp = sel.closest('.chantier-block')?.querySelector('.mc_camping')?.value || '';
        applyAffaireOptionStyles(sel, camp);
      });
      document.querySelectorAll('.it_affaire').forEach(sel=>{
        const camp = sel.closest('.interim-block')?.querySelector('.it_camping')?.value || '';
        applyAffaireOptionStyles(sel, camp);
      });
    }

    function applyCampingOptionStyles(sel){
      if(!sel) return;
      Array.from(sel.options).forEach(opt=>{
        const c = opt.value;
        const highlighted = c && assignedCampings.has(c);
        decorateOption(opt, 'opt-assigned-camp', highlighted, '★ ');
      });
    }

    function applyAffaireOptionStyles(sel, camping){
      if(!sel) return;
      const set = camping ? assignedAffaires.get(camping) : null;
      Array.from(sel.options).forEach(opt=>{
        const aff = opt.value;
        const highlighted = !!(set && set.has(aff));
        decorateOption(opt, 'opt-assigned-aff', highlighted, '★ ');
      });
    }

    function renderTachesToday(list){
      const box = document.getElementById('tachesToday');
      if (!box) return;
      if (!list.length) { box.innerHTML = '<div class="muted">Aucune tâche aujourd\'hui.</div>'; return; }
      const sorted = list.slice().sort((a,b)=>{
        const ca=(a.camping||'').toLowerCase(), cb=(b.camping||'').toLowerCase();
        if (ca!==cb) return ca.localeCompare(cb,'fr',{sensitivity:'base'});
        const aa=(a.affaire||'').toLowerCase(), ab=(b.affaire||'').toLowerCase();
        if (aa!==ab) return aa.localeCompare(ab,'fr',{sensitivity:'base'});
        const ta=(a.tache||'').toLowerCase(), tb=(b.tache||'').toLowerCase();
        return ta.localeCompare(tb,'fr',{sensitivity:'base'});
      });
      let html = '<ul style="padding-left:22px;font-size:38px;">';
      sorted.forEach(t=>{
        html += `<li><b>${escapeHtml(t.camping||'')}</b> / ${escapeHtml(t.affaire||'')} — ${escapeHtml(t.tache||'')} ${t.commentaire?('(' + escapeHtml(t.commentaire) + ')'):''}</li>`;
      });
      html += '</ul>';
      box.innerHTML = html;
    }

    function renderMesTaches(list){
      const box = document.getElementById('tachesContent');
      if (!box) return;
      if (!list.length) { box.innerHTML = '<div class="muted">Aucune tâche sur cette période.</div>'; return; }

      const sorted = list.slice().sort((a,b)=>{
        const da=a.date||'', db=b.date||'';
        if (da!==db) return da<db?-1:1;
        const ca=(a.camping||'').toLowerCase(), cb=(b.camping||'').toLowerCase();
        if (ca!==cb) return ca.localeCompare(cb,'fr',{sensitivity:'base'});
        const aa=(a.affaire||'').toLowerCase(), ab=(b.affaire||'').toLowerCase();
        return aa.localeCompare(ab,'fr',{sensitivity:'base'});
      });

      let html = '<table><thead><tr>';
      html += '<th>Date</th><th>Camping</th><th>Affaire</th><th>Tâche</th><th>Commentaire</th>';
      html += '</tr></thead><tbody>';
      sorted.forEach(t => {
        html += `<tr>
          <td>${escapeHtml(fmtDateDisplay(t.date) || '')}</td>
          <td>${escapeHtml(t.camping || '')}</td>
          <td>${escapeHtml(t.affaire || '')}</td>
          <td>${escapeHtml(t.tache || '')}</td>
          <td>${escapeHtml(t.commentaire || '')}</td>
        </tr>`;
      });
      html += '</tbody></table>';
      box.innerHTML = html;
    }

    function afficherValides(){
      const meta = document.querySelector('meta[name="viewport"]');
      if (meta) meta.setAttribute('content', 'width=device-width, initial-scale=1, user-scalable=yes');
      const panel=document.getElementById('validesPanel');
      if(panel){
        panel.style.display='block';
        panel.setAttribute('aria-hidden','false');
        document.getElementById('fixedFooter').style.display = 'none';
      }
      actualiserValides();
    }
    function fermerValides(){
      const meta = document.querySelector('meta[name="viewport"]');
      if (meta) meta.setAttribute('content', 'width=device-width, initial-scale=1, user-scalable=no');
      const panel=document.getElementById('validesPanel');
      if(panel){
        panel.style.display='none';
        panel.setAttribute('aria-hidden','true');
        document.getElementById('fixedFooter').style.display = 'flex';
      }
    }
    function resetValidesFilters(){
      setDefaultValidesDates();
      actualiserValides();
    }
    async function actualiserValides(){
      const status = document.getElementById('valStatus');
      if(status) status.textContent = 'Chargement...';
      const df = document.getElementById('valDateFrom')?.value || '';
      const dt = document.getElementById('valDateTo')?.value || '';
      try{
        let list = [];
        if (USE_LOCAL){
          list = await apiPost('/getPayeValidee', { dateFrom: df, dateTo: dt, salarie: currentUser || '' });
        } else {
          list = await new Promise((resolve,reject)=>{
            google.script.run.withSuccessHandler(resolve).withFailureHandler(reject).getPayeValidee(df, dt, currentUser || '');
          });
        }
        cachedValides = list || [];
        renderValides(cachedValides);
        if(status) status.textContent = cachedValides.length ? (cachedValides.length + ' ligne(s)') : 'Aucune donnée.';
      }catch(err){
        console.error(err);
        if(status) status.textContent = 'Erreur: ' + err;
      }
    }
    function renderValides(list){
      const box = document.getElementById('valContent');
      if(!box) return;
      if(!list || !list.length){
        box.innerHTML = '<div class="muted">Aucune donnée sur la période.</div>';
        return;
      }
      const header = ['Date','Travail','Déplacement','Panier midi','Panier soir','Zone','Forfait trajet','HSup','HNuit','Découchés','WE','Validé par','Validé le','Commentaire'];
      let html='<div class="h-scrollbar"><div class="h-scrollbar-inner"></div></div>';
      html+='<div class="table-wrap"><table><thead><tr>';
      header.forEach(h=>html+='<th>'+escapeHtml(h)+'</th>');
      html+='</tr></thead><tbody>';
      list.forEach(r=>{
        html+='<tr>'+
          `<td>${escapeHtml(fmtDateDisplay(r.date)||'')}</td>`+
          `<td>${escapeHtml(minToHHMM(r.travailMin))}</td>`+
          `<td>${escapeHtml(minToHHMM(r.deplacementMin))}</td>`+
          `<td>${escapeHtml(r.panierMidi||'')}</td>`+
          `<td>${escapeHtml(r.panierSoir||'')}</td>`+
          `<td>${escapeHtml(r.zone||'')}</td>`+
          `<td>${escapeHtml(r.forfaitTrajet||'')}</td>`+
          `<td>${escapeHtml(minToHHMM(r.heuresSupMin))}</td>`+
          `<td>${escapeHtml(minToHHMM(r.heuresNuitMin))}</td>`+
          `<td>${escapeHtml(r.decouches||'')}</td>`+
          `<td>${escapeHtml(r.forfaitWeekend||'')}</td>`+
          `<td>${escapeHtml(r.validePar||'')}</td>`+
          `<td>${escapeHtml(fmtDateTimeDisplay(r.valideLe)||'')}</td>`+
          `<td>${escapeHtml(r.commentaire||'')}</td>`+
        '</tr>';
      });
      html+='</tbody></table><div style="height:340px;"></div></div>';
      box.innerHTML = html;

      const wrap = box.querySelector('.table-wrap');
      const hsb  = box.querySelector('.h-scrollbar');
      const hsbInner = box.querySelector('.h-scrollbar-inner');
      if (wrap && hsb && hsbInner) {
        hsbInner.style.width = wrap.scrollWidth + 'px';
        hsb.scrollLeft = wrap.scrollLeft;
        hsb.addEventListener('scroll', () => { wrap.scrollLeft = hsb.scrollLeft; });
        wrap.addEventListener('scroll', () => { hsb.scrollLeft = wrap.scrollLeft; });
      }
    }
    async function exportValidesPDF(){
      if (!cachedValides || !cachedValides.length) {
        alert("Aucune donnée à exporter. Cliquez sur Actualiser d'abord.");
        return;
      }
      const df = document.getElementById('valDateFrom')?.value || '';
      const dt = document.getElementById('valDateTo')?.value || '';
      const periodText = (df||dt)
        ? `Période : ${df?fmtDateDisplay(df):'...'} au ${dt?fmtDateDisplay(dt):'...'}` :
        'Période : toutes dates';
      const salText = 'Salarié : ' + (currentUser || '');
      const genDate = new Date();
      const genText = 'Exporté le : ' + fmtDateDisplay(genDate.toISOString().slice(0,10)) + ' ' + genDate.toTimeString().slice(0,5);

      try{
        await ensureJsPDF();
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF('l','pt','a4');
        doc.setFontSize(14);
        doc.text('Pointages validés', 16, 24);
        doc.setFontSize(11);
        doc.text(periodText, 16, 42);
        doc.text(salText, 16, 58);
        doc.text(genText, 16, 74);

        const head = [[
          'Date','Travail','Déplacement','Panier midi','Panier soir','Zone','Forfait trajet','HSup','HNuit','Découchés','WE','Validé par','Validé le','Commentaire'
        ]];
        const body = cachedValides.map(r=>[
          fmtDateDisplay(r.date)||'',
          minToHHMM(r.travailMin),
          minToHHMM(r.deplacementMin),
          r.panierMidi||'',
          r.panierSoir||'',
          r.zone||'',
          r.forfaitTrajet||'',
          minToHHMM(r.heuresSupMin),
          minToHHMM(r.heuresNuitMin),
          r.decouches||'',
          r.forfaitWeekend||'',
          r.validePar||'',
          fmtDateTimeDisplay(r.valideLe)||'',
          r.commentaire||''
        ]);

        doc.autoTable({
          head,
          body,
          styles:{ fontSize:8, cellPadding:4 },
          headStyles:{ fillColor:[37,99,235], textColor:255 },
          alternateRowStyles:{ fillColor:[240,245,255] },
          margin:{ top:90, bottom:24, left:16, right:16 }
        });

        doc.save('pointages-valides.pdf');
      }catch(e){
        alert(e && e.message ? e.message : e);
      }
    }

    function ajouterInterimaire(prefill){
      const tpl = document.getElementById('interimTpl');
      const n = tpl.content.cloneNode(true);
      const container = document.getElementById('interimContainer');
      container.appendChild(n);
      const block = container.lastElementChild;
      const sel = block.querySelector('.it_camping');
      sel.innerHTML = '<option value="">-- Choisir --</option>';
      const uniq=[...new Set((campingsAffaires||[]).map(o=>o.camping))]
        .sort((a,b)=>a.localeCompare(b,'fr',{sensitivity:'base'}));
      uniq.forEach(c=>{
        const o=document.createElement('option'); o.value=c; o.textContent=c;
        sel.appendChild(o);
      });
      applyCampingOptionStyles(sel);
      renumberInterimaires();
      if(prefill){
        if(prefill.nom) block.querySelector('.it_nom').value = prefill.nom;
        if(prefill.camping) block.querySelector('.it_camping').value = prefill.camping;
        majAffairesInterimaireBlock(sel);
        if(prefill.affaire) block.querySelector('.it_affaire').value = prefill.affaire;
        if(prefill.tache) block.querySelector('.it_tache').value = prefill.tache;
        if(prefill.heureDebut) block.querySelector('.it_debut').value = prefill.heureDebut;
        if(prefill.heureFin) block.querySelector('.it_fin').value = prefill.heureFin;
      }
      const affSel = block.querySelector('.it_affaire');
      applyAffaireOptionStyles(affSel, block.querySelector('.it_camping')?.value || '');
    }
    function supprimerInterimaire(btn){ const block = btn.closest('.interim-block'); if(block) { block.remove(); renumberInterimaires(); } }
    function viderInterimaires(){ document.getElementById('interimContainer').innerHTML = ''; }

    function renumberInterimaires(){
      const blocks = Array.from(document.querySelectorAll('#interimContainer .interim-block'));
      blocks.forEach((b,i)=>{ const t = b.querySelector('.interim-title'); if(t) t.textContent = 'Intérimaire ' + (i+1); });
    }

    function majAffairesInterimaireBlock(el){
      const block = el.closest('.interim-block');
      const affSel = block.querySelector('.it_affaire');
      affSel.innerHTML = '<option value="">-- Choisir --</option>';
      (campingsAffaires||[]).filter(o=>o.camping===el.value).forEach(o=>{
        const opt=document.createElement('option'); opt.value=o.affaire; opt.textContent=o.affaire; affSel.appendChild(opt);
      });
      applyCampingOptionStyles(el);
      applyAffaireOptionStyles(affSel, el.value);
    }
    function scrollIntoViewIfNeeded(el){
      if (!el) return;
      const rect = el.getBoundingClientRect();
      const vh = window.innerHeight || document.documentElement.clientHeight;
      if (rect.top < 0 || rect.bottom > vh){
        el.scrollIntoView({ behavior: 'smooth', block: 'start', inline: 'nearest' });
      }
    }
    function ajouterChantier(prefill){
      document.getElementById('loadingIndicator').style.display = 'inline';
      document.querySelectorAll('.entry-actions button').forEach(btn => btn.disabled = true);

      const tpl = document.getElementById('chantierTpl');
      const n = tpl.content.cloneNode(true);
      const container = document.getElementById('entriesContainer');
      container.appendChild(n);
      const block = container.lastElementChild;
      const sel = block.querySelector('.mc_camping');
      sel.innerHTML = '<option value="">-- Choisir --</option>';
      const uniq = [...new Set((campingsAffaires||[]).map(o=>o.camping))]
        .sort((a,b)=>a.localeCompare(b,'fr',{sensitivity:'base'}));
      uniq.forEach(c=>{
        const o=document.createElement('option'); o.value=c; o.textContent=c; sel.appendChild(o);
      });
      applyCampingOptionStyles(sel);
      renumberEntries();
      scrollIntoViewIfNeeded(block);
      document.getElementById('loadingIndicator').style.display = 'none';
      document.querySelectorAll('.entry-actions button').forEach(btn => btn.disabled = false);
      if (prefill) {
        if (prefill.camping) block.querySelector('.mc_camping').value = prefill.camping;
        majAffairesChantier(block.querySelector('.mc_camping'));
        if (prefill.affaire) block.querySelector('.mc_affaire').value = prefill.affaire;
        if (prefill.tache) block.querySelector('.mc_tache').value = prefill.tache;
        if (prefill.heureDebut) block.querySelector('.mc_heureDebut').value = prefill.heureDebut;
        if (prefill.heureFin) block.querySelector('.mc_heureFin').value = prefill.heureFin;
      }
      const affSel = block.querySelector('.mc_affaire');
      applyAffaireOptionStyles(affSel, block.querySelector('.mc_camping')?.value || '');
    }
    function ajouterDeplacement(prefill){
      document.getElementById('loadingIndicator').style.display = 'inline';
      document.querySelectorAll('.entry-actions button').forEach(btn => btn.disabled = true);

      const tpl = document.getElementById('deplacementTpl');
      const n = tpl.content.cloneNode(true);
      const container = document.getElementById('entriesContainer');
      container.appendChild(n);
      const block = container.lastElementChild;
      renumberEntries();
      scrollIntoViewIfNeeded(block);
      document.getElementById('loadingIndicator').style.display = 'none';
      document.querySelectorAll('.entry-actions button').forEach(btn => btn.disabled = false);
      if(prefill){
        block.querySelector('.dtype').value = prefill.type || 'domicile';
        block.querySelector('.d-debut').value = prefill.heureDebut || '';
        block.querySelector('.d-fin').value = prefill.heureFin || '';
        block.querySelector('.d-comment').value = prefill.commentaire || '';
      }
    }
    function supprimerEntry(btn){ const block = btn.closest('.chantier-block, .deplacement-block'); if(block) { block.remove(); renumberEntries(); } }

    function renumberEntries(){
      const container = document.getElementById('entriesContainer');
      const blocks = Array.from(container.querySelectorAll('.chantier-block, .deplacement-block'));
      let chantierCount = 0;
      let deplacementCount = 0;
      blocks.forEach((b) => {
        if (b.classList.contains('chantier-block')) {
          chantierCount++;
          const t = b.querySelector('.chantier-title');
          if (t) t.textContent = 'Chantier ' + chantierCount;
        } else if (b.classList.contains('deplacement-block')) {
          deplacementCount++;
          const t = b.querySelector('.deplacement-title');
          if (t) t.textContent = 'Déplacement ' + deplacementCount;
        }
      });
    }

    function majAffairesChantier(el){
      const block = el.closest('.chantier-block');
      const affSel = block.querySelector('.mc_affaire');
      affSel.innerHTML = '<option value="">-- Choisir --</option>';
      (campingsAffaires||[]).filter(o=>o.camping===el.value).forEach(o=>{
        const opt=document.createElement('option'); opt.value=o.affaire; opt.textContent=o.affaire; affSel.appendChild(opt);
      });
      applyCampingOptionStyles(el);
      applyAffaireOptionStyles(affSel, el.value);
    }
    function ajouterPause(btnOrBlock){
      let block = null;
      if (btnOrBlock && btnOrBlock.closest) block = btnOrBlock.closest('.chantier-block');
      if (!block && btnOrBlock && btnOrBlock.classList && btnOrBlock.classList.contains('chantier-block')) block = btnOrBlock;
      if(!block) return;
      if(block.querySelector('.mc_pause_block')) {
        block.querySelector('.mc_pause_block').style.display = 'block';
        return;
      }
      const div = document.createElement('div');
      div.className='mc_pause_block';
      div.innerHTML = `
        <label>Pause début
          <input type="time" class="mc_heurePause">
        </label>
        <div class="error-text mc_err_pause" style="display:none;"></div>
        <label>Pause fin
          <input type="time" class="mc_heureReprise">
        </label>
        <div class="error-text mc_err_reprise" style="display:none;"></div>
      `;
      block.appendChild(div);
    }

    function clearAllErrors(){ document.querySelectorAll('.error-text').forEach(e=>{ e.textContent=''; e.style.display='none'; }); document.getElementById('msg').textContent=''; document.getElementById('transferStatus').textContent=''; document.getElementById('transferStatus').className='status-text'; document.getElementById('btnValider').disabled = false; }
    function showError(id, msg){ const el = document.getElementById('err_' + id); if(!el) return; el.textContent = msg||''; el.style.display = msg ? 'block' : 'none'; }
    function showMsg(text){ const el = document.getElementById('msg'); el.textContent = text || ''; if(!text) el.style.display='none'; else el.style.display='block'; setTimeout(()=>{ el.textContent=''; },4000); }

    function setTransferStatus(text, ok){
      const el = document.getElementById('transferStatus');
      el.textContent = text || '';
      if (ok === true) { el.className = 'status-text status-green'; }
      else if (ok === false) { el.className = 'status-text status-red'; }
      else { el.className = 'status-text'; }
    }

    function majTypePersonne(){
      clearAllErrors();
      const t = document.getElementById('typePersonne').value;
      const formSections = document.getElementById('form-sections');
      if (t) {
        formSections.classList.remove('hidden');
        document.getElementById('bloc-interimaire').classList.toggle('hidden', t !== 'interimaire');
        document.getElementById('entries-section').classList.toggle('hidden', t === 'interimaire');
        if(t === 'interimaire' && !document.getElementById('interimContainer').children.length) ajouterInterimaire();
      } else {
        formSections.classList.add('hidden');
      }
      refreshOptionHighlights();
    }

    async function valider(){
      clearAllErrors();
      setTransferStatus('TRANSFERT EN COURS', true);
      document.getElementById('btnValider').disabled = true;

      if(!currentUser){ setTransferStatus('', null); showError('global','Aucun utilisateur connecté.'); document.getElementById('btnValider').disabled = false; return; }
      const type = document.getElementById('typePersonne').value;
      if(!type){ setTransferStatus('', null); showError('typePersonne','Requis'); document.getElementById('btnValider').disabled = false; return; }

      if (type === 'interimaire') {
        const blocks = Array.from(document.querySelectorAll('#interimContainer .interim-block'));
        if (blocks.length === 0) { setTransferStatus('', null); showError('entries','Au moins un intérimaire requis'); document.getElementById('btnValider').disabled = false; return; }

        const entries = [];
        let ok = true;
        blocks.forEach((b) => {
          const nom = b.querySelector('.it_nom').value.trim();
          const camping = b.querySelector('.it_camping').value;
          const affaire = b.querySelector('.it_affaire').value;
          const debut = b.querySelector('.it_debut').value;
          const fin = b.querySelector('.it_fin').value;
          const tache = b.querySelector('.it_tache').value.trim();

          if(!nom){ const e=b.querySelector('.it_err_nom'); e.textContent='Requis'; e.style.display='block'; ok = false; }
          if(!camping){ const e=b.querySelector('.it_err_camping'); e.textContent='Requis'; e.style.display='block'; ok = false; }
          if(!affaire){ const e=b.querySelector('.it_err_affaire'); e.textContent='Requis'; e.style.display='block'; ok = false; }
          if(!debut){ const e=b.querySelector('.it_err_debut'); e.textContent='Requis'; e.style.display='block'; ok = false; }
          if(!fin){ const e=b.querySelector('.it_err_fin'); e.textContent='Requis'; e.style.display='block'; ok = false; }

          entries.push({ nom, camping, affaire, heureDebut: debut, heureFin: fin, commentaire: tache });
        });

        if(!ok){ setTransferStatus('', null); document.getElementById('btnValider').disabled = false; return; }

        let success = 0, fail = 0;
        async function sendNext(i){
          if (i >= entries.length) {
            if (fail === 0) setTransferStatus('ENREGISTRÉ', true);
            else setTransferStatus('ERREUR (' + fail + ')', false);
            showMsg('Terminé : ' + success + ' réussis, ' + fail + ' échecs.');
            document.getElementById('btnValider').disabled = false;
            setTimeout(()=>{ setTransferStatus('', null); }, 2500);
            reinitialiserFormulaire();
            return;
          }
          const en = entries[i];
          const payload = {
            nom: en.nom,
            typePersonne: 'interimaire',
            entries: [{
              type: 'chantier',
              camping: en.camping,
              affaire: en.affaire,
              heureDebut: en.heureDebut,
              heurePause: '',
              heureReprise: '',
              heureFin: en.heureFin,
              commentaire: en.commentaire || ''
            }]
          };
          try{
            if(USE_LOCAL){
              await apiPost('/enregistrerPointageV2', payload); // si endpoint local existe
            }else{
              await new Promise((resolve,reject)=>{
                google.script.run.withSuccessHandler(resolve).withFailureHandler(reject).enregistrerPointageV2(payload);
              });
            }
            success++;
          }catch(err){ fail++; console.error('Erreur envoi intérimaire', en.nom, err); }
          sendNext(i+1);
        }
        sendNext(0);
        return;
      }

      const entryBlocks = Array.from(document.querySelectorAll('#entriesContainer .chantier-block, #entriesContainer .deplacement-block'));
      if(entryBlocks.length === 0){ setTransferStatus('', null); showError('entries','Au moins une entrée requise'); document.getElementById('btnValider').disabled = false; return; }

      const entries = [];
      let ok = true;
      entryBlocks.forEach((b) => {
        const isChantier = b.classList.contains('chantier-block');
        if (isChantier) {
          const camping = b.querySelector('.mc_camping').value;
          const affaire = b.querySelector('.mc_affaire').value;
          const tache = b.querySelector('.mc_tache').value.trim();
          const debut = b.querySelector('.mc_heureDebut').value;
          const fin = b.querySelector('.mc_heureFin').value;
          const pauseEl = b.querySelector('.mc_heurePause');
          const repriseEl = b.querySelector('.mc_heureReprise');
          let pause = '', reprise = '';
          if (pauseEl && repriseEl) { pause = pauseEl.value; reprise = repriseEl.value; }

          if(!camping){ const e=b.querySelector('.mc_err_camping'); e.textContent='Requis'; e.style.display='block'; ok=false; }
          if(!affaire){ const e=b.querySelector('.mc_err_affaire'); e.textContent='Requis'; e.style.display='block'; ok=false; }
          if(!tache){ const e=b.querySelector('.mc_err_tache'); e.textContent='Requis'; e.style.display='block'; ok=false; }
          if(!debut){ const e=b.querySelector('.mc_err_debut'); e.textContent='Requis'; e.style.display='block'; ok=false; }
          if(!fin){ const e=b.querySelector('.mc_err_fin'); e.textContent='Requis'; e.style.display='block'; ok=false; }
          if(pauseEl && !pause){ const e=b.querySelector('.mc_err_pause'); e.textContent='Requis'; e.style.display='block'; ok=false; }
          if(repriseEl && !reprise){ const e=b.querySelector('.mc_err_reprise'); e.textContent='Requis'; e.style.display='block'; ok=false; }

          entries.push({
            type: 'chantier',
            camping: camping,
            affaire: affaire,
            heureDebut: debut,
            heurePause: pause,
            heureReprise: reprise,
            heureFin: fin,
            commentaire: tache
          });
        } else {
          const dtype = b.querySelector('.dtype').value;
          const comment = b.querySelector('.d-comment').value.trim();
          const debut = b.querySelector('.d-debut').value;
          const fin = b.querySelector('.d-fin').value;

          if(!comment){ const e=b.querySelector('.d_err_comment'); e.textContent='Requis'; e.style.display='block'; ok = false; }
          if(!debut){ const e=b.querySelector('.d_err_debut'); e.textContent='Requis'; e.style.display='block'; ok = false; }
          if(!fin){ const e=b.querySelector('.d_err_fin'); e.textContent='Requis'; e.style.display='block'; ok = false; }

          entries.push({
            type: 'deplacement',
            dtype: dtype,
            heureDebut: debut,
            heureFin: fin,
            commentaire: comment
          });
        }
      });
      if(!ok){ setTransferStatus('', null); document.getElementById('btnValider').disabled = false; return; }

      const payload = {
        nom: currentUser,
        typePersonne: type,
        entries: entries
      };

      try{
        if(USE_LOCAL){
          await apiPost('/enregistrerPointageV2', payload); // si endpoint local existe
          setTransferStatus('ENREGISTRÉ', true);
          showMsg('Enregistré (local)');
        }else{
          const count = await new Promise((resolve,reject)=>{
            google.script.run.withSuccessHandler(resolve).withFailureHandler(reject).enregistrerPointageV2(payload);
          });
          setTransferStatus('ENREGISTRÉ', true);
          showMsg('Enregistré (' + count + ' lignes ajoutées)');
        }
        reinitialiserFormulaire();
        document.getElementById('btnValider').disabled = false;
        setTimeout(()=>{ setTransferStatus('', null); }, 2500);
      }catch(err){
        setTransferStatus('ERREUR', false);
        showError('global','Erreur serveur: ' + (err && err.message ? err.message : 'Erreur'));
        console.error(err);
        document.getElementById('btnValider').disabled = false;
      }
    }

    function reinitialiserFormulaire(){
      document.getElementById('typePersonne').value = '';
      document.getElementById('form-sections').classList.add('hidden');
      document.getElementById('entriesContainer').innerHTML = '';
      document.getElementById('interimContainer').innerHTML = '';
      clearAllErrors();
    }

    function afficherHistorique(){
      const meta = document.querySelector('meta[name="viewport"]');
      if (meta) meta.setAttribute('content', 'width=device-width, initial-scale=1, user-scalable=yes');
      const panel=document.getElementById('historyPanel');
      panel.style.display='block';
      panel.setAttribute('aria-hidden','false');
      document.getElementById('historyContent').innerHTML='<div class="muted">Clique sur Appliquer pour charger l\'historique.</div>';
      document.getElementById('fixedFooter').style.display = 'none';
    }

    function callHistorique(renderNow){
      if (USE_LOCAL){
        applyHistoryFilters();
        return;
      }
      google.script.run
        .withSuccessHandler(function(data){
          cachedHistory=data;
          populateHistoryFilterOptions();
          if(renderNow) renderHistory(filterCachedHistory());
        })
        .withFailureHandler(function(err){
          cachedHistory=null;
          if(renderNow) renderHistory([]);
          showError('global', 'Erreur chargement historique : ' + (err && err.message ? err.message : 'Erreur inconnue'));
          setTimeout(() => showError('global', ''), 5000);
        })
        .getHistoriquePointages();
    }

    function populateHistoryFilterOptions(){
      if(!cachedHistory || cachedHistory.length<2) return;
      const header = cachedHistory[0].map(h=> (h||'').toString().toLowerCase());
      historyHeaderIndices = {
        date: header.findIndex(h=>h.includes('date')),
        nom: header.findIndex(h=>h.includes('nom')),
        camping: header.findIndex(h=>h.includes('camping'))
      };
      const salSelect = document.getElementById('histSalarie');
      const campSelect = document.getElementById('histCamping');
      if(!salSelect || !campSelect) return;
      salSelect.innerHTML = '<option value="">Tous</option>';
      campSelect.innerHTML = '<option value="">Tous</option>';
      const names = new Set();
      const camps = new Set();
      for(let i=1;i<cachedHistory.length;i++){
        const row = cachedHistory[i];
        if(historyHeaderIndices.nom>=0) names.add(row[historyHeaderIndices.nom]||'');
        if(historyHeaderIndices.camping>=0) camps.add(row[historyHeaderIndices.camping]||'');
      }
      Array.from(names).sort((a,b)=>a.localeCompare(b,'fr',{sensitivity:'base'})).forEach(n=>{ if(n){ const o=document.createElement('option'); o.value=n; o.textContent=n; salSelect.appendChild(o); }});
      Array.from(camps).sort((a,b)=>a.localeCompare(b,'fr',{sensitivity:'base'})).forEach(c=>{ if(c){ const o=document.createElement('option'); o.value=c; o.textContent=c; campSelect.appendChild(o); }});
    }

    async function applyHistoryFilters(){
      if(USE_LOCAL){
        try{
          const data = await apiPost('/getHistoriquePointagesFiltered', {
            dateFrom: document.getElementById('histDateFrom').value || '',
            dateTo: document.getElementById('histDateTo').value || '',
            salarie: document.getElementById('histSalarie').value || '',
            camping: document.getElementById('histCamping').value || ''
          });
          cachedHistory = data || [];
          if(cachedHistory && cachedHistory.length){
            const header = cachedHistory[0].map(h=> (h||'').toString().toLowerCase());
            historyHeaderIndices = {
              date: header.findIndex(h=>h.includes('date')),
              nom: header.findIndex(h=>h.includes('nom')),
              camping: header.findIndex(h=>h.includes('camping'))
            };
          }
          renderHistory(filterCachedHistory());
        }catch(err){
          cachedHistory = null;
          renderHistory([]);
          showError('global','Erreur chargement historique (local): '+err);
          setTimeout(()=>showError('global',''),4000);
        }
        return;
      }
      google.script.run
        .withSuccessHandler(function(data){
          cachedHistory=data;
          renderHistory(filterCachedHistory());
        })
        .withFailureHandler(function(err){
          cachedHistory=null;
          renderHistory([]);
          showError('global','Erreur chargement historique : ' + (err && err.message ? err.message : 'Erreur inconnue'));
          setTimeout(() => showError('global', ''), 5000);
        })
        .getHistoriquePointagesFiltered(
          document.getElementById('histDateFrom').value || '',
          document.getElementById('histDateTo').value || '',
          document.getElementById('histSalarie').value || '',
          document.getElementById('histCamping').value || ''
        );
    }

    function resetHistoryFilters(){
      document.getElementById('histDateFrom').value='';
      document.getElementById('histDateTo').value='';
      document.getElementById('histSalarie').value='';
      document.getElementById('histCamping').value='';
      if(cachedHistory){
        renderHistory(filterCachedHistory());
      } else {
        document.getElementById('historyContent').innerHTML='<div class="muted">Clique sur Appliquer pour charger l\'historique.</div>';
      }
    }

    function parseCellDate(s){
      if(!s) return null; s = s.toString().trim();
      const iso = /^\d{4}-\d{2}-\d{2}$/; const dmy = /^(\d{2})\/(\d{2})\/(\d{4})$/;
      if(iso.test(s)) return new Date(s+'T00:00:00');
      const m=s.match(dmy); if(m) return new Date(m[3]+'-'+m[2]+'-'+m[1]+'T00:00:00');
      const pd=new Date(s); return isNaN(pd.getTime())?null:pd;
    }

    function filterCachedHistory(){
      if(!cachedHistory) return [];
      const rows = cachedHistory.slice(1);
      const header = cachedHistory[0];
      const fromVal = document.getElementById('histDateFrom').value;
      const toVal = document.getElementById('histDateTo').value;
      const sal = document.getElementById('histSalarie').value;
      const camp = document.getElementById('histCamping').value;
      const dateFrom = fromVal ? new Date(fromVal+'T00:00:00') : null;
      const dateTo = toVal ? new Date(toVal+'T23:59:59') : null;
      const idxDate = historyHeaderIndices.date, idxNom = historyHeaderIndices.nom, idxCamp = historyHeaderIndices.camping;
      const filtered = rows.filter(r=>{
        let ok = true;
        if(idxDate>=0 && (dateFrom || dateTo)){
          const cellDate = parseCellDate(r[idxDate]); if(!cellDate) return false;
          if(dateFrom && cellDate < dateFrom) ok = false;
          if(dateTo && cellDate > dateTo) ok = false;
        }
        if(idxNom>=0 && sal){ if((r[idxNom]||'').toString() !== sal) ok = false; }
        if(idxCamp>=0 && camp){ if((r[idxCamp]||'').toString() !== camp) ok = false; }
        return ok;
      });
      return [header].concat(filtered);
    }

    function renderHistory(data){
      const content=document.getElementById('historyContent');
      if(!data||data.length===0){ content.innerHTML='<div>Aucun historique.</div>'; return;}

      const header=data[0];
      const hasRowIdx = header[header.length-1] === 'ROW_INDEX';
      const visibleHeader = hasRowIdx ? header.slice(0,-1) : header;

      let html='<div class="h-scrollbar"><div class="h-scrollbar-inner"></div></div>';
      html+='<div class="table-wrap"><table><thead><tr>';
      visibleHeader.forEach(h=>html+='<th>'+escapeHtml(h||'')+'</th>');
      html+='</tr></thead><tbody>';
      for(let i=1;i<data.length;i++){
        const cells = hasRowIdx ? data[i].slice(0,-1) : data[i];
        html+='<tr>';
        cells.forEach(c=>html+='<td>'+escapeHtml(c||'')+'</td>');
        html+='</tr>';
      }
      html+='</tbody></table><div style="height:340px;"></div></div>';
      content.innerHTML=html;

      const wrap = content.querySelector('.table-wrap');
      const hsb  = content.querySelector('.h-scrollbar');
      const hsbInner = content.querySelector('.h-scrollbar-inner');
      if (wrap && hsb && hsbInner) {
        hsbInner.style.width = wrap.scrollWidth + 'px';
        hsb.scrollLeft = wrap.scrollLeft;
        hsb.addEventListener('scroll', () => { wrap.scrollLeft = hsb.scrollLeft; });
        wrap.addEventListener('scroll', () => { hsb.scrollLeft = wrap.scrollLeft; });
      }
    }

    function telechargerCSV(){} // placeholder

    async function telechargerPDF(){
      const btn=document.getElementById('btnExportPDF');
      if(btn){btn.disabled=true;btn.textContent='Génération PDF...';}
      try{
        const data = filterCachedHistory();
        if(!data || data.length<=1) throw new Error('Aucune donnée à exporter. Clique Appliquer d\'abord.');

        const header=data[0];
        const hasRowIdx = header[header.length-1] === 'ROW_INDEX';
        const headForPdf = hasRowIdx ? header.slice(0, -1) : header;
        const bodyForPdf = data.slice(1).map(r => hasRowIdx ? r.slice(0, -1) : r);

        await ensureJsPDF();
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF('l','pt','a4');

        const df = document.getElementById('histDateFrom').value || '';
        const dt = document.getElementById('histDateTo').value || '';
        const sal = document.getElementById('histSalarie').value || '';
        const camp = document.getElementById('histCamping').value || '';
        const periodText = (df||dt)
          ? `Période : ${df?fmtDateDisplay(df):'...'} au ${dt?fmtDateDisplay(dt):'...'}` : 'Période : toutes dates';
        const salText = 'Salarié : ' + (sal||'Tous');
        const campText = 'Camping : ' + (camp||'Tous');
        const genDate = new Date();
        const genText = 'Généré le : ' + fmtDateDisplay(fmtDateLocal(genDate)) + ' ' + genDate.toTimeString().slice(0,5);

        doc.setFontSize(14);
        doc.text('Rapport Pointages', 16, 24);
        doc.setFontSize(11);
        doc.text(periodText, 16, 42);
        doc.text(salText, 16, 58);
        doc.text(campText, 16, 74);
        doc.text(genText, 16, 90);

        doc.autoTable({
          head: [headForPdf.map(h=>h||'')],
          body: bodyForPdf.map(r=>r.map(c=>fmtHHMM(c)||'')),
          styles:{ fontSize:8, cellPadding:4 },
          headStyles:{ fillColor:[37,99,235], textColor:255 },
          alternateRowStyles:{ fillColor:[240,245,255] },
          margin:{ top:110, bottom:24, left:16, right:16 }
        });

        doc.save('historique_pointages.pdf');
      }catch(e){
        showError('global','Erreur PDF: ' + (e.message||e));
        setTimeout(()=>showError('global',''),4000);
      }finally{
        if(btn){btn.disabled=false;btn.textContent='Exporter PDF';}
      }
    }

    async function ensureJsPDF() {
      const needJsPDF = (typeof window.jspdf === 'undefined' || typeof window.jspdf.jsPDF === 'undefined');
      const needAuto  = (typeof window.jspdf === 'undefined' || !window.jspdf.jsPDF || !window.jspdf.jsPDF.API?.autoTable);
      if (!needJsPDF && !needAuto) return;
      await loadScriptOnce('https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js', 'jspdf');
      await loadScriptOnce('https://cdn.jsdelivr.net/npm/jspdf-autotable@3.8.2/dist/jspdf.plugin.autotable.min.js', 'autoTable');
      if (typeof window.jspdf === 'undefined' || typeof window.jspdf.jsPDF === 'undefined') {
        throw new Error("jsPDF non disponible après chargement.");
      }
    }
    function loadScriptOnce(src, label) {
      return new Promise((resolve, reject) => {
        if (label === 'jspdf' && window.jspdf && window.jspdf.jsPDF) return resolve();
        if (label === 'autoTable' && window.jspdf && window.jspdf.jsPDF && window.jspdf.jsPDF.API?.autoTable) return resolve();
        const existing = document.querySelector(`script[data-src="${src}"]`);
        if (existing) {
          existing.addEventListener('load', () => resolve());
          existing.addEventListener('error', () => reject(new Error('Échec chargement ' + src)));
          return;
        }
        const s = document.createElement('script');
        s.src = src; s.async = true; s.defer = true; s.dataset.src = src;
        s.onload = () => resolve();
        s.onerror = () => reject(new Error('Échec chargement ' + src));
        document.head.appendChild(s);
      });
    }

    function afficherPlanning(){
      const meta = document.querySelector('meta[name="viewport"]');
      if (meta) meta.setAttribute('content', 'width=device-width, initial-scale=1, user-scalable=yes');
      setDefaultPlanningDates();
      const panel=document.getElementById('planningPanel');
      panel.style.display='block';
      panel.setAttribute('aria-hidden','false');
      document.getElementById('fixedFooter').style.display = 'none';
      document.getElementById('planningContent').innerHTML='<div class="muted">Chargement...</div>';
      actualiserPlanning();
    }

    async function actualiserPlanning(){
      const df = document.getElementById('planDateFrom').value || '';
      const dt = document.getElementById('planDateTo').value || '';
      const content = document.getElementById('planningContent');
      if (content) content.innerHTML = '<div class="muted">Chargement...</div>';
      try{
        let list = [];
        if (USE_LOCAL){
          const today = new Date().toISOString().slice(0,10);
          list = await apiPost('/getPlanning', { startIso: df || today, endIso: dt || today });
        }else{
          list = await new Promise((resolve,reject)=>{
            google.script.run.withSuccessHandler(resolve).withFailureHandler(reject).getPlanning(df || new Date().toISOString().slice(0,10), dt || new Date().toISOString().slice(0,10));
          });
        }
        cachedPlanning = list || [];
        renderPlanningGrid(cachedPlanning);
      }catch(err){
        console.error(err);
        if (content) content.innerHTML = '<div class="muted">Erreur de chargement.</div>';
      }
    }

    function resetPlanningFilters(){
      setDefaultPlanningDates();
      const sel = document.getElementById('planSalarie');
      if (sel) sel.value='';
      document.getElementById('planningContent').innerHTML = '<div class="muted">Choisissez une plage de dates puis cliquez sur Appliquer.</div>';
      cachedPlanning = null;
    }

    function renderPlanningGrid(list){
      const content = document.getElementById('planningContent');
      if (!content) return;
      const df = document.getElementById('planDateFrom').value || '';
      const dt = document.getElementById('planDateTo').value || '';
      if (!list || !list.length){
        content.innerHTML = '<div class="muted">Aucune tâche sur cette période.</div>';
        return;
      }
      const sel = document.getElementById('planSalarie');
      const selVal = sel ? sel.value : '';
      const filtered = selVal ? list.filter(p => (p.salarie||'') === selVal) : list;

      const start = df ? new Date(df+'T00:00:00') : new Date(Math.min(...filtered.map(p=>new Date(p.date))));
      const end   = dt ? new Date(dt+'T00:00:00') : new Date(Math.max(...filtered.map(p=>new Date(p.date))));
      const days = [];
      let cur = new Date(start);
      while(cur <= end){ days.push(new Date(cur)); cur = addDays(cur,1); }
      const todayIso = new Date().toISOString().slice(0,10);

      const uniqEmp = planningEmployees.length
        ? planningEmployees.slice()
        : Array.from(new Set(filtered.map(p=>p.salarie).filter(Boolean))).sort((a,b)=>a.localeCompare(b,'fr',{sensitivity:'base'}));

      const headerCells = ['<th class="col-emp">Salarié</th>'].concat(days.map(day=>{
        const isToday = fmtDateLocal(day) === todayIso;
        const label = day.toLocaleDateString('fr-FR',{weekday:'short',day:'2-digit',month:'2-digit'});
        return `<th class="col-day ${isToday?'today-col':''}">${escapeHtml(label)}</th>`;
      })).join('');

      const bodyRows = uniqEmp.map(emp=>{
        const cells = ['<th class="col-emp">'+escapeHtml(emp)+'</th>'].concat(days.map(day=>{
          const dateStr = fmtDateLocal(day);
          const isToday = dateStr === todayIso;
          const cellTasks = filtered.filter(p=>p.salarie===emp && p.date===dateStr);
          const tasksHtml = cellTasks.map(t=>{
            return `<div class="pill"><small>${escapeHtml(t.camping||'')} / ${escapeHtml(t.affaire||'')}</small>${escapeHtml(t.tache||'')} (${escapeHtml(t.debut||'')}-${escapeHtml(t.fin||'')})</div>`;
          }).join('');
          return `<td class="col-day ${isToday?'today-col':''}">${tasksHtml || '<span class="muted" style="font-size:24px;">—</span>'}</td>`;
        }));
        return '<tr>'+cells.join('')+'</tr>';
      }).join('');

      content.innerHTML = `
        <div class="planning-container">
          <table class="planning-table">
            <thead><tr>${headerCells}</tr></thead>
            <tbody>${bodyRows}</tbody>
          </table>
          <div style="height:340px;"></div>
        </div>
      `;
    }

    function fermerHistorique(){
      const meta = document.querySelector('meta[name="viewport"]');
      if (meta) meta.setAttribute('content', 'width=device-width, initial-scale=1, user-scalable=no');
      const panel=document.getElementById('historyPanel');
      panel.style.display='none';
      panel.setAttribute('aria-hidden','true');
      document.getElementById('fixedFooter').style.display = 'flex';
    }

    function fermerPlanning(){
      const meta = document.querySelector('meta[name="viewport"]');
      if (meta) meta.setAttribute('content', 'width=device-width, initial-scale=1, user-scalable=no');
      const panel=document.getElementById('planningPanel');
      panel.style.display='none';
      panel.setAttribute('aria-hidden','true');
      document.getElementById('fixedFooter').style.display = 'flex';
    }

    function escapeHtml(s){
      return String(s)
        .replace(/&/g,'&amp;')
        .replace(/</g,'&lt;')
        .replace(/>/g,'&gt;')
        .replace(/"/g,'&quot;')
        .replace(/'/g,'&#39;');
    }

    window.logout = logout;
    window.ajouterInterimaire = ajouterInterimaire;
    window.viderInterimaires = viderInterimaires;
    window.supprimerInterimaire = supprimerInterimaire;
    window.majAffairesInterimaireBlock = majAffairesInterimaireBlock;
    window.ajouterChantier = ajouterChantier;
    window.ajouterDeplacement = ajouterDeplacement;
    window.supprimerEntry = supprimerEntry;
    window.majAffairesChantier = majAffairesChantier;
    window.ajouterPause = ajouterPause;
    window.chargerMesTaches = chargerMesTaches;
    window.applyHistoryFilters = applyHistoryFilters;
    window.resetHistoryFilters = resetHistoryFilters;
    window.afficherPlanning = afficherPlanning;
    window.actualiserPlanning = actualiserPlanning;
    window.resetPlanningFilters = resetPlanningFilters;
    window.fermerPlanning = fermerPlanning;
    window.telechargerPDF = telechargerPDF;
    window.telechargerCSV = telechargerCSV;
    window.afficherValides = afficherValides;
    window.fermerValides = fermerValides;
    window.resetValidesFilters = resetValidesFilters;
    window.actualiserValides = actualiserValides;
    window.exportValidesPDF = exportValidesPDF;
  </script>
</body>
</html>
